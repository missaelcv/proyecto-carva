<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Probando Canvas</title>
    <style>
        canvas {
            border: 1px solid gray;
            margin: auto;
            display: block;
        }
        img {
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="miCanvas" width="1000" height="500"></canvas>

    <img src="imagenes/gato1.png" alt="" id="gato1">
    <img src="imagenes/gato2.png" alt="" id="gato2">
    <img src="imagenes/gato3.png" alt="" id="gato3">
    <img src="imagenes/gato4.png" alt="" id="gato4">
    <img src="imagenes/gato5.png" alt="" id="gato5">
    <img src="imagenes/gato6.png" alt="" id="gato6">
    <img src="imagenes/gato7.png" alt="" id="gato7">
    <img src="imagenes/gato8.png" alt="" id="gato8">
    <script>

        var PropCanvas={
        intervalo:undefined,
        estaPausado: false,
        posicionHorizontal:undefined,
        };
        
        let miCanvas = document.getElementById("miCanvas");
        let contexto = miCanvas.getContext("2d");
        let anchura = miCanvas.width;
        let altura = miCanvas.height;
        // let intervalo;
        // let estaPausado = false;
        let estaSubiendo= false;
        let estaSaltando = false;
        // let posicionHorizontal;

        function dibujarObstaculo(tipoObstaculo){

        }

        let obstaculos = [
        ]; //{ x, y, anchura, altura }
        

        for (let i = 0, x = anchura; i < 50; i++, x+= Math.round( Math.random() * 400 ) + 600 ) {
            obstaculos.push( { x: x, y: altura - 100, anchura: 70 , altura: 100, dibujar:function(contexto){
            contexto.fillStyle = "rgb(150, 0, 0)";
            contexto.beginPath();
            contexto.fillRect(this.x, this.y, this.anchura, this.altura);

            contexto.fillStyle = "black";
            contexto.beginPath();
            contexto.fillText( i, this.x + 10, this.y);
            contexto.fill();

        }
        } );
        }


        function gradosARadianes( grados ) {
            return grados * (Math.PI/180);
        }

        //1 - Dibujar Cuadricula
        function dibujarCuadricula( variacion = 20 ) {
            for( let x = variacion; x < anchura; x += variacion) {
                crearLinea({x, y:0}, {x, y: altura}).dibujar();
            }

            for( let y = variacion; y < altura; y += variacion) {
                crearLinea({x:0, y}, {x:anchura, y}).dibujar();
            }
        }

        //4- Dibujar una imagen
        let imagenActual = 1,
            imagen = document.getElementById(`gato${ imagenActual }`),
            anchuraImagenInicial,
            alturaImagenInicial,
            anchuraImagen = imagen.width, 
            alturaImagen = imagen.height,
            estaCreciendo = false,
            contidadASaltar = 0;

         imagen.onload = dibujarImagen;

        function dibujarImagen() {        
            anchuraImagenInicial = anchuraImagenInicial || imagen.width;
            alturaImagenInicial = alturaImagenInicial || imagen.height;
            anchuraImagen = anchuraImagenInicial / 2;//anchuraImagen || anchuraImagenInicial; 
            alturaImagen = alturaImagenInicial / 2; //alturaImagen || alturaImagenInicial;

            let porcentajeAltura = anchuraImagenInicial/alturaImagenInicial;

            PropCanvas.posicionHorizontal =  PropCanvas.posicionHorizontal || 0;

            let tiempo = 70;
            let xInicial = 0;
            let tamanioMinimoImagen = 60;
            let tamanioMaximoImagen = 500;
            PropCanvas.intervalo = setInterval( () => {
                // console.log(imagenActual);
                // console.log("anchuraImagen: ", anchuraImagen);
                // console.log("alturaImagen: ", alturaImagen);
                
                contexto.beginPath();
                contexto.fillStyle = "#eee";
                contexto.fillRect(0,0, anchura, altura);

                let variacionHorizontal = 20;
                // console.log( "variacionHorizontal: ", variacionHorizontal );

                //posicionHorizontal += variacionHorizontal;
                if(PropCanvas.posicionHorizontal > anchura) {
                    PropCanvas.posicionHorizontal = -anchuraImagen;
                }

                //dibujar el piso
                contexto.beginPath();
                contexto.fillStyle = "gray";
                contexto.fillRect(0,altura - 20, anchura, 20);

                //dibujar lineas verticales para hacer mas realista el movimiento
                let variacion = anchuraImagen;
                for( let x = anchura - xInicial; x > -variacion ; x -= variacion) {
                    contexto.beginPath();
                    contexto.strokeStyle = "black";
                    contexto.moveTo( x, 0 );
                    contexto.lineTo( x, altura - 20 );
                    contexto.stroke();

                    contexto.beginPath();
                    contexto.strokeStyle = "white";
                    contexto.moveTo( x, altura - 20 );
                    contexto.lineTo( x + 40, altura);
                    contexto.stroke();

                    contexto.beginPath();
                    contexto.strokeStyle = "white";
                    contexto.moveTo( x + variacion/2, altura - 20 );
                    contexto.lineTo( x + variacion/2 + 40, altura);
                    contexto.stroke();
                }

                xInicial += variacionHorizontal;
                if(xInicial > variacion) {
                    xInicial = 0;
                }

                //anchuraImagen = anchuraImagen + (estaCreciendo ? 1 : -1);
                //alturaImagen = anchuraImagen / porcentajeAltura;

                let posicionVertical = altura - alturaImagen;

                contexto.strokeStyle = "black";

                //dibujar lineas linea horizontales desde encima de la imagen para hacer aun mas realista el movimiento
                for (let y = posicionVertical; y > 0; y -= altura - posicionVertical) {
                    contexto.beginPath();
                    contexto.moveTo( 0, y );
                    contexto.lineTo( anchura, y );
                    contexto.stroke(); 
                }

                if( estaSaltando) {
                    imagenActual = 8;
                }
                else {
                    imagenActual+=2
                    if( imagenActual > 8) {
                        imagenActual = 1;
                    }
                }
                
                
                let maximoAInclinar = 50;

                //dibujar la imagen del gato
                contexto.save();

                contexto.translate(PropCanvas.posicionHorizontal,posicionVertical);
                if(estaSaltando) {
                    contexto.restore();
                    contexto.save();
                    contexto.translate(PropCanvas.posicionHorizontal, estaSubiendo? posicionVertical: posicionVertical-alturaImagen);
                    cantidadAInclinar += (estaSubiendo? 10:-10) ;
                    if(cantidadAInclinar > maximoAInclinar) {
                        cantidadAInclinar = maximoAInclinar;
                        estaSubiendo=false;
                    }

                    if(estaSubiendo){
                        contexto.rotate( gradosARadianes( cantidadAInclinar == maximoAInclinar ? 0 : -cantidadAInclinar) );
                        
                    }
                    else{
                        contexto.rotate( gradosARadianes(cantidadAInclinar) );
                        if(cantidadAInclinar<=0){
                            estaSaltando=false;
                        }
                    }
                    
                }
                else {
                    cantidadAInclinar =0;
                    estaSaltando=false;
                }
                
                console.log('estaSubiendo: ',estaSubiendo);

                console.log('estaSaltando:', estaSaltando);

                imagen = document.getElementById(`gato${ cantidadAInclinar == maximoAInclinar ? 2 : imagenActual }`);
                contexto.drawImage(imagen, 0, ( cantidadAInclinar == maximoAInclinar ? -alturaImagen * 1.5 : 0), anchuraImagen, alturaImagen);

                contexto.strokeStyle = "red";
                //contexto.strokeRect( 0, ( cantidadAInclinar == maximoAInclinar ? -alturaImagen * 1.5 : 0), anchuraImagen, alturaImagen);
                contexto.restore();
                
                if( anchuraImagen < tamanioMinimoImagen || alturaImagen < tamanioMinimoImagen) {
                    estaCreciendo = true;
                }

                if( anchuraImagen > tamanioMaximoImagen || alturaImagen > tamanioMaximoImagen) {
                    estaCreciendo = false;
                }


                for (let i = 0; i < obstaculos.length; i++) {
                    const obstaculo = obstaculos[i];
                    obstaculo.dibujar(contexto);

                    obstaculo.x -= variacionHorizontal;
                }
            }, tiempo); 
        }

        miCanvas.addEventListener("click", () => {
            if( PropCanvas.estaPausado ) {
                dibujarImagen();
            }
            else {
                clearInterval(PropCanvas.intervalo);
            }

            PropCanvas.estaPausado = !PropCanvas.estaPausado;
        });

        document.addEventListener("keypress", function() {
           if(!estaSaltando){
            estaSaltando = true;
            estaSubiendo= true;
           }
        
        });
        // document.addEventListener("keyup", function() {
        //     estaSaltando = false;
        // });
    </script>
</body>
</html>